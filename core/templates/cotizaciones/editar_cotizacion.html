{% extends 'base.html' %}
{% block title %}Editar Cotizaci√≥n{% endblock %}
{% block content %}

<div class="contenedor">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %} 

  <h2>üìù Editar Cotizaci√≥n</h2>
  <br><br>
  <form method="post" action="{% url 'crear_cotizacion' %}" id="cotizacion-form">
    {% csrf_token %}

    <div class="venta-layout">
      
      <!-- Columna izquierda -->
      <div class="columna-izquierda">
        <!-- üîç Buscador -->
        <div class="form-group">
          <label for="codigo_input">üîé Buscar producto por ID, c√≥digo o c√≥digo de barra:</label>
          <input type="text" id="codigo_input" placeholder="Ej. 12345 o ABC001" autofocus class="form-control">
          <button type="button" class="btn btn-primary mt-2" id="add-by-code-btn">Agregar</button>
          <div id="error-msg" style="color: red; margin-top: 5px;"></div>
        </div>

        <!-- üí∞ Total -->
        <div class="form-group mt-3">
          <strong>Total:</strong> L <span id="total-display">0.00</span>
        </div>

        <!-- üßç Cliente -->
        <h4 class="mt-3">üßç Cliente</h4>
        <div class="cliente-form">
          {{ cotizacion_form.as_p }}
        </div>

        <!-- ‚öôÔ∏è Bot√≥n guardar -->
        <div class="botones-acciones mt-3">
          <button type="submit" class="btn btn-primary w-100" id="guardar-btn" disabled>üíæ Actualizar Cotizaci√≥n</button>
        </div>
      </div>

      <!-- Columna centro -->
      <div class="columna-centro">
        <h4>üõí Productos</h4>
        {{ formset.management_form }}
        <div id="form-container" class="border p-2" style="min-height:300px; overflow-y:auto;">
          {% for form in formset %}
            <div class="form-row" data-form-index="{{ forloop.counter0 }}">
              {% for hidden in form.hidden_fields %}
                {{ hidden }}
              {% endfor %}

              <div class="cantidad-input">
                {{ form.cantidad.label_tag }}
                {{ form.cantidad }}
              </div>

              <div class="precio-input">
                {{ form.precio_unitario.label_tag }}
                {{ form.precio_unitario }}
                <span class="nombre-producto fw-bold d-block mt-1"></span>
              </div>

              <div class="acciones-producto">
                <button type="button" class="remove-btn">‚ùå</button>
                <button type="button" class="discount-btn btn btn-sm btn-warning mt-2">üí∏ -6%</button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Columna derecha -->
      <div class="columna-derecha">
        <h6>‚ö° Accesos r√°pidos</h6>
        <div class="d-grid gap-2">
          {% for p in productos %}
            <button type="button" class="btn btn-outline-primary quick-product" data-codigo="{{ p.codigo }}">
              {{ p.nombre }}
            </button>
          {% endfor %}
        </div>
      </div>

    </div>
  </form>
</div> 



<script>
document.addEventListener('DOMContentLoaded', () => {
  const formContainer    = document.getElementById('form-container');
  const totalFormsInput  = document.getElementById('id_form-TOTAL_FORMS');
  const addByCodeBtn     = document.getElementById('add-by-code-btn');
  const codigoInput      = document.getElementById('codigo_input');
  const errorMsg         = document.getElementById('error-msg');
  const totalDisplay     = document.getElementById('total-display');
  const guardarBtn       = document.getElementById('guardar-btn');

  const emptyFormHTML = formContainer.firstElementChild
    ? formContainer.firstElementChild.outerHTML
    : '';

  function verificarProductosActivos() {
    let hayProductos = false;
    document.querySelectorAll('.form-row').forEach(row => {
      const producto = row.querySelector('input[name$="-producto"]');
      const cantidad = row.querySelector('input[name$="-cantidad"]');
      const precio   = row.querySelector('input[name$="-precio_unitario"]');
      if (producto && producto.value && cantidad && parseInt(cantidad.value) > 0 && precio && parseFloat(precio.value) > 0) {
        hayProductos = true;
      }
    });
    guardarBtn.disabled = !hayProductos;
  }

  function actualizarTotal() {
    let total = 0;
    document.querySelectorAll('.form-row').forEach(row => {
      const precio = parseFloat(row.querySelector('input[name$="-precio_unitario"]').value) || 0;
      const qty    = parseInt(row.querySelector('input[name$="-cantidad"]').value) || 0;
      const descuento = parseFloat(row.querySelector('input[name$="-descuento"]').value) || 0;

      let precioFinal = precio;
      if (descuento > 0) {
        precioFinal = precio - (precio * (descuento / 100));
      }
      total += precioFinal * qty;
    });
    totalDisplay.innerText = total.toFixed(2);
    verificarProductosActivos();
  }

  function buscarYAgregar(codigoDirecto = null) {
    const codigo = codigoDirecto ? codigoDirecto.trim() : codigoInput.value.trim();
    if (errorMsg) errorMsg.innerText = '';
    if (!codigo) { errorMsg.innerText = 'Ingrese un c√≥digo v√°lido'; return; }

    fetch(`/buscar-producto/?codigo=${encodeURIComponent(codigo)}`)
      .then(r => r.json())
      .then(json => {
        if (!json.encontrado) { errorMsg.innerText = 'Producto no encontrado'; return; }

        // Verificar si ya existe
        const productosExistentes = document.querySelectorAll('input[name$="-producto"]');
        let productoExiste = false;
        productosExistentes.forEach(inputHidden => {
          if (inputHidden.value == json.id) {
            const row = inputHidden.closest('.form-row');
            const cantidadInput = row.querySelector('input[name$="-cantidad"]');
            if (cantidadInput) cantidadInput.value = parseInt(cantidadInput.value || 0) + 1;
            const nombreSpanExistente = row.querySelector('.nombre-producto');
            if (nombreSpanExistente && !nombreSpanExistente.textContent.trim()) nombreSpanExistente.textContent = json.nombre;
            productoExiste = true;
          }
        });
        
          if (productoExiste) {
            actualizarTotal();
            codigoInput.value = '';
            // Evitar abrir teclado en tablets
            if (!('ontouchstart' in window)) {
              codigoInput.focus();
            }
            return;
          }

        // Crear nueva fila
        const currentCount = parseInt(totalFormsInput.value);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = emptyFormHTML.replace(/form-(\d+)-/g, `form-${currentCount}-`);
        const newRow = tempDiv.firstElementChild;

        // Campo oculto producto
        const productoInputHidden = newRow.querySelector(`input[name="form-${currentCount}-producto"]`);
        if (productoInputHidden) productoInputHidden.value = json.id;

        // Mostrar nombre debajo del precio
        const nombreSpan = newRow.querySelector('.nombre-producto');
        if (nombreSpan) nombreSpan.textContent = json.nombre;

        // Cantidad y precio
        const cantidadInput  = newRow.querySelector(`input[name="form-${currentCount}-cantidad"]`);
        const precioInput    = newRow.querySelector(`input[name="form-${currentCount}-precio_unitario"]`);
        if (cantidadInput)  cantidadInput.value  = 1;
        if (precioInput)    precioInput.value    = json.precio;

        formContainer.insertBefore(newRow, formContainer.firstChild);
        totalFormsInput.value = currentCount + 1;
        actualizarTotal();
        codigoInput.value = '';
        codigoInput.focus();
      })
      .catch(error => {
        console.error('Error:', error);
        errorMsg.innerText = 'Error al buscar el producto';
      });
  }

  if (addByCodeBtn) {
    addByCodeBtn.addEventListener('click', () => buscarYAgregar());
  }

  if (codigoInput) {
    codigoInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        buscarYAgregar();
      }
    });
  }

  document.addEventListener('input', verificarProductosActivos);
  document.addEventListener('change', verificarProductosActivos);

  // Eliminar fila y reindexar
  formContainer.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-btn')) {
      e.preventDefault();
      const row = e.target.closest('.form-row');
      row.remove();

      const filas = document.querySelectorAll('.form-row');
      filas.forEach((fila, index) => {
        fila.querySelectorAll('input, select, textarea').forEach(input => {
          input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
          input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
        });
      });
      totalFormsInput.value = filas.length;
      actualizarTotal();
      verificarProductosActivos();
    }

    // Descuento
    if (e.target.classList.contains('discount-btn')) {
      const row = e.target.closest('.form-row');
      const descuentoInput = row.querySelector('input[name$="-descuento"]');
      if (descuentoInput) descuentoInput.value = 6;
      e.target.disabled = true;
      e.target.innerText = "‚úî Descuento aplicado";
      actualizarTotal();
    }
  });

  // Inicializar nombres de productos en filas existentes
  function inicializarNombresProductos() {
    document.querySelectorAll('.form-row').forEach(row => {
      const productoId = row.querySelector('input[name$="-producto"]')?.value;
      const nombreSpan = row.querySelector('.nombre-producto');
      if (productoId && nombreSpan && !nombreSpan.textContent.trim()) {
        fetch(`/buscar-producto-id/?id=${encodeURIComponent(productoId)}`)
          .then(r => r.json())
          .then(json => { if (json.encontrado) nombreSpan.textContent = json.nombre; })
          .catch(err => console.error('Error obteniendo nombre:', err));
      }
    });
  }

  // Limpiar filas vac√≠as antes de enviar
  document.getElementById('cotizacion-form').addEventListener('submit', function() {
    const filas = document.querySelectorAll('.form-row');
    let index = 0;
    filas.forEach(row => {
      const producto = row.querySelector('input[name$="-producto"]');
      if (!producto || !producto.value) {
        row.remove();
      } else {
        row.querySelectorAll('input, select, textarea').forEach(input => {
          input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
          input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
        });
        index++;
      }
    });
    totalFormsInput.value = index;
  });

  // Inicializar
  inicializarNombresProductos();
  actualizarTotal();
  verificarProductosActivos();

  // Accesos r√°pidos
  document.querySelectorAll('.quick-product').forEach(btn => {
    btn.addEventListener('click', function() {
      const codigo = this.getAttribute('data-codigo');
      buscarYAgregar(codigo);
    });
  });

// Prevenir que botones t√°ctiles abran teclado
document.querySelectorAll('.quick-product').forEach(btn => {
  btn.addEventListener('touchstart', e => e.preventDefault());
});  

});
</script>

{% endblock %} 